#!/bin/sh
# version @@VERSION@@
#   Copyright (C) 2007-2009 Erik Auerswald <auerswald@fg-networking.de>
#   Copyright (C) 2006-2008 JÃ¶rg Mayer <jmayer@fg-networking.de>
#
#   This program is free software: you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation, either version 3 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program.  If not, see <http://www.gnu.org/licenses/>.

# unset variables are a script error
set -u

# read configuration
. /etc/fgn-backup.conf

# include function-modules
for MODULE in $MODULELIST; do
    . ${MODULEPATH}/${MODULE}
done

# parse commandline
while getopts "Vh" option; do
    case $option in
        V)      show_version; exit 0;;
        h)      usage; exit 0;;
        \?)     usage; exit 1;;
        *)      echo "getopts error: getopts returned $option";;
    esac
done
shift $(($OPTIND - 1))

# true: create backup data and save to ftp server
# false: only save files
if [ 1 = 1 ]; then
    init_logfiles
    dump_mysql_dbs 2>&1 | tee -a "${BACKUPLOG}"
    tar_partitions 2>&1 | tee -a "${BACKUPLOG}"
# only save files
fi

# upload archives to FTP server
ftp_upload 2>&1 | tee -a "${BACKUPLOG}"

# check free space on FTP server
check_free_ftp_space 2>&1 | tee -a "${BACKUPLOG}"

exit 0

# vim:filetype=sh:shiftwidth=4:expandtab:
